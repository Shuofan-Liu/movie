<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Movie!</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="./css/styles.css" />

  <!-- Firebase SDK (Compat) placed before app scripts) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body>
  <!-- å·¦ä¸Šè§’ç”¨æˆ·å…¥å£ -->
  <div class="user-corner" id="userCorner">
    <!-- æœªç™»å½•æ—¶æ˜¾ç¤ºç«ç„° -->
    <div class="corner-flame" id="cornerFlame" onclick="showLoginModal()">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
        <path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/>
      </svg>
    </div>
    
    <!-- ç™»å½•åæ˜¾ç¤ºç”¨æˆ·å¤´åƒ -->
    <div class="corner-avatar" id="cornerAvatar" onclick="toggleUserMenu()" style="display:none;">
      <div class="corner-avatar-img" id="cornerAvatarImg"></div>
      <div class="corner-badge" id="cornerBadge" style="display:none;">0</div>
    </div>
  </div>

  <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
  <div class="user-dropdown" id="userDropdown">
    <div class="user-dropdown-header">
        <div class="dropdown-avatar" id="dropdownAvatar"></div>
        <div class="dropdown-info" style="display:flex; align-items:center; gap:8px; justify-content:space-between; width:100%;">
          <div class="dropdown-nickname" id="dropdownNickname"></div>
          <!-- åå­—å³ä¾§å±•ç¤ºå…³ç³»å¾½æ ‡ï¼ˆ>2 æŠ˜å ä¸º Xä¸ªå…³ç³»ï¼‰ -->
          <div class="dropdown-relations" id="dropdownRelations"></div>
        </div>
    </div>
    <div class="user-dropdown-body">
      <div class="dropdown-info-item">
        <strong>æœ€å–œæ¬¢çš„å¯¼æ¼”ï¼š</strong><span id="dropdownDirector"></span>
      </div>
      <div class="dropdown-info-item">
        <strong>æœ€å–œæ¬¢çš„ç”µå½±ï¼š</strong><span id="dropdownFilm"></span>
      </div>
      <div class="dropdown-badges" id="dropdownBadges"></div>
        <!-- ç”µå½±é£æ ¼ç§»åŠ¨åˆ°å¾½ç« ä¸‹æ–¹ä¸€è¡Œå±•ç¤º -->
        <div class="dropdown-style-below" id="dropdownStyleBelow" style="margin-top:6px; color:#bbb; font-size:13px;"></div>
    </div>
    <div class="user-dropdown-actions">
        <button class="dropdown-btn" onclick="showUserPage(window.currentUser.id)">ğŸ‘¤ æŸ¥çœ‹æˆ‘çš„ä¸»é¡µ</button>
        <button class="dropdown-btn" onclick="editOwnProfile()">âœï¸ ç¼–è¾‘èµ„æ–™</button>
        <button class="dropdown-btn" onclick="showMyMessages()">ğŸ“¬ æŸ¥çœ‹æˆ‘çš„ç•™è¨€ <span id="dropdownMsgPill" style="display:none; margin-left:6px; padding:2px 6px; background:var(--avatar-glow-color); border:1px solid var(--avatar-border-color); color:var(--avatar-border-color); border-radius:10px; font-size:12px;"></span></button>
        <button class="dropdown-btn" onclick="showRelationshipCenter()">ğŸ¤ å…³ç³»å¤„ç† <span id="dropdownRelPill" style="display:none; margin-left:6px; padding:2px 6px; background:var(--avatar-glow-color); border:1px solid var(--avatar-border-color); color:var(--avatar-border-color); border-radius:10px; font-size:12px;"></span></button>
      <button class="dropdown-btn" onclick="showAdminPrompt()">ğŸ‘‘ ç®¡ç†å‘˜æ¨¡å¼</button>
      <button class="dropdown-btn" onclick="logoutUser()">ğŸšª é€€å‡ºç™»å½•</button>
      <button class="dropdown-btn danger" onclick="deleteOwnAccount()">âš ï¸ æ³¨é”€è´¦æˆ·</button>
    </div>
  </div>

  <!-- ç”µå½±èƒ¶ç‰‡èƒŒæ™¯ -->
  <div class="film-strip-background" id="filmBackground"></div>

  <!-- æµåŠ¨è¯—æ„æ’ç‰ˆçš„å¯¼æ¼”åå­— -->
  <div class="directors-layer" id="directorsLayer"></div>

  <!-- å·¦ä¸‹è§’æµ‹éªŒæŒ‰é’®ï¼ˆä»…ç™»å½•åæ˜¾ç¤ºï¼‰ -->
  <div class="quiz-icon-button" id="quizIconButton" onclick="startQuiz()" title="å¼€å§‹æµ‹éªŒ" style="display:none;">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
      <path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
    </svg>
  </div>

  <!-- emojiæ¸¸æˆå‡ºé¢˜æŒ‰é’®ï¼ˆç™»å½•åæ˜¾ç¤ºï¼Œä½ç½®ï¼šå·¦ä¸‹è§’ç¬¬äºŒä¸ªï¼‰ -->
  <div class="emoji-create-button" id="emojiCreateButton" onclick="showEmojiCreatePage()" title="å‡ºé¢˜" style="display:none;">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
      <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
      <path d="M5.5 16c.83 0 1.5-.67 1.5-1.5S6.33 13 5.5 13 4 13.67 4 14.5 4.67 16 5.5 16z"/>
      <path d="M18.5 16c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5z"/>
    </svg>
  </div>

  <!-- emojiæ¸¸æˆå¤§å…æŒ‰é’®ï¼ˆç™»å½•åæ˜¾ç¤ºï¼Œä½ç½®ï¼šåº•éƒ¨ä¸­é—´ï¼‰ -->
  <div class="emoji-hall-button" id="emojiHallButton" onclick="showEmojiHallPage()" title="çŒœé¢˜å¤§å…" style="display:none;">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
      <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.76 16.24l-1.41 1.41C4.78 16.1 4 14.05 4 12c0-2.05.78-4.1 2.34-5.66l1.41 1.41C6.59 8.93 6 10.46 6 12s.59 3.07 1.76 4.24zM12 16l-4-4h8l-4 4zm5.66 1.66l-1.41-1.41C17.41 15.07 18 13.54 18 12s-.59-3.07-1.76-4.24l1.41-1.41C19.22 7.9 20 9.95 20 12c0 2.05-.78 4.1-2.34 5.66z"/>
    </svg>
    <div class="emoji-hall-badge" id="emojiHallBadge" style="display:none;">0</div>
  </div>

  <!-- emojiæ¸¸æˆæ’è¡Œæ¦œæŒ‰é’®ï¼ˆç™»å½•åæ˜¾ç¤ºï¼Œç´§é‚»å¤§å…æŒ‰é’®ï¼‰ -->
  <div class="emoji-leaderboard-button" id="emojiLeaderboardButton" onclick="showEmojiLeaderboard()" title="æ’è¡Œæ¦œ" style="display:none;">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
      <path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/>
    </svg>
  </div>

  <!-- å³ä¸‹è§’å¼¹å¹•å¢™æŒ‰é’®ï¼ˆä»…ç™»å½•åæ˜¾ç¤ºï¼Œç”µå½±æ‘„å½±æœºiconï¼‰ -->
  <div class="danmaku-icon-button" id="danmakuButton" onclick="toggleDanmakuWall()" title="ç•™è¨€å¢™" style="display:none;">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
      <path d="M18,11.34V6.11C18,5.5,17.5,5,16.89,5H5.11C4.5,5,4,5.5,4,6.11v11.78C4,18.5,4.5,19,5.11,19h11.78c0.61,0,1.11-0.5,1.11-1.11v-5.23l4,3.62V7.72L18,11.34z M7,9h2v2H7V9z M7,13h2v2H7V13z M15,13v2h-2v-2H15z M15,9v2h-2V9H15z"/>
    </svg>
  </div>

  <!-- å¯¼æ¼”å¼¹çª— -->
  <div class="modal" id="directorModal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- æµ‹éªŒè¦†ç›–å±‚ -->
  <div class="quiz-overlay" id="quizOverlay">
    <!-- æµ‹éªŒé¡µé¢ -->
    <div id="quizPage" class="quiz-container">
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="question-number" id="questionNumber">é—®é¢˜ 1 / 5</div>
      <div class="question-text" id="questionText"></div>
      <div class="question-image hidden" id="questionImage"><img id="questionImg" alt="question" /></div>
      <div id="answerContainer">
        <input id="answerInput" class="answer-input" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" />
        <div id="optionsContainer" class="options-container hidden"></div>
      </div>
      <button class="quiz-button" onclick="handleNext()">ä¸‹ä¸€é¢˜</button>
      <button class="quiz-button" onclick="closeQuiz()">å…³é—­</button>
    </div>
  </div>

  <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
  <div class="login-modal-overlay" id="loginModalOverlay" onclick="closeLoginModal()"></div>
  <div class="login-modal" id="loginModal">
    <span class="modal-close" onclick="closeLoginModal()">&times;</span>
    
    <!-- ç™»å½•/æ³¨å†Œé€‰æ‹© -->
    <div id="loginChoice" class="login-choice">
      <h2>Welcome!</h2>
      <button class="choice-button" onclick="showRegisterForm()">ğŸ”¥ ç¬¬ä¸€æ¬¡æ¥ï¼Ÿ</button>
      <button class="choice-button" onclick="showLoginForm()">âœ¨ å·²ç»æ¥è¿‡ï¼Ÿ</button>
    </div>

    <!-- ç™»å½•è¡¨å• -->
    <div id="loginForm" class="auth-form hidden">
      <h2>ç™»å½•</h2>
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="loginNickname">æ˜µç§°</label>
          <input id="loginNickname" type="text" required placeholder="è¾“å…¥ä½ çš„æ˜µç§°" />
        </div>
        <div class="form-group">
          <label for="loginPassword">å¯†ç </label>
          <input id="loginPassword" type="password" required placeholder="è¾“å…¥ä½ çš„å¯†ç " />
        </div>
        <button type="submit" class="submit-button">ç™»å½•</button>
        <button type="button" class="back-button" onclick="showLoginChoice()">è¿”å›</button>
      </form>
    </div>

    <!-- æ³¨å†Œè¡¨å• -->
    <div id="registerForm" class="auth-form hidden">
      <h2>æ³¨å†Œ</h2>
      <form onsubmit="handleRegister(event)" id="regForm">
        <!-- å¤´åƒé€‰æ‹©å™¨ -->
        <div class="form-group">
          <label>é€‰æ‹©å¤´åƒ *</label>
          <small>ç‚¹å‡»é€‰æ‹©ï¼Œæœªé€‰æ‹©å°†è‡ªåŠ¨ç”Ÿæˆé¦–å­—æ¯å¤´åƒ</small>
          <div class="avatar-selector" id="avatarSelector"></div>
          <input type="hidden" id="selectedAvatar" value="" />
        </div>

        <!-- æ˜µç§° -->
        <div class="form-group">
          <label for="regNickname">æ˜µç§° *</label>
          <input id="regNickname" type="text" required placeholder="è¾“å…¥ä½ çš„æ˜µç§°" />
        </div>

        <!-- å¯†ç  -->
        <div class="form-group">
          <label for="regPassword">å¯†ç  *</label>
          <input id="regPassword" type="password" required placeholder="è‡³å°‘4ä¸ªå­—ç¬¦" />
        </div>
        <div class="form-group">
          <label for="regPasswordConfirm">ç¡®è®¤å¯†ç  *</label>
          <input id="regPasswordConfirm" type="password" required placeholder="å†æ¬¡è¾“å…¥å¯†ç " />
        </div>

        <!-- æœ€å–œæ¬¢çš„å¥³å¯¼æ¼” -->
        <div class="form-group">
          <label for="favoriteDirector">æœ€å–œæ¬¢çš„å¥³å¯¼æ¼” *</label>
          <input id="favoriteDirector" type="text" required placeholder="å¦‚ï¼šé˜¿æ¶…æ–¯Â·ç“¦å°”è¾¾" />
        </div>

        <!-- æœ€å–œæ¬¢çš„å¥³æ€§ç”µå½± -->
        <div class="form-group">
          <label for="favoriteFilm">æœ€å–œæ¬¢çš„å¥³æ€§ç”µå½± *</label>
          <input id="favoriteFilm" type="text" required placeholder="å¦‚ï¼šç‡ƒçƒ§å¥³å­çš„è‚–åƒ" />
        </div>

        <!-- æœ€è¿‘çœ‹çš„ç”µå½±ï¼ˆå¯é€‰ï¼‰ -->
        <div class="form-group">
          <label for="recentFilm">æœ€è¿‘çœ‹çš„ä¸€éƒ¨ç”µå½±ï¼ˆå¯é€‰ï¼‰</label>
          <input id="recentFilm" type="text" placeholder="å¦‚ï¼šé˜¿æ¶…æ–¯è®ºç“¦å°”è¾¾" />
        </div>

        <!-- åˆ†äº«æƒ³æ³•ï¼ˆå¯é€‰ï¼‰ -->
        <div class="form-group">
          <label for="thoughts">åˆ†äº«ä½ æœ€è¿‘å¥½ç©çš„æƒ³æ³•ï¼ˆå¯é€‰ï¼‰</label>
          <textarea id="thoughts" rows="3" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
        </div>

        <button type="submit" class="submit-button">æ³¨å†Œ</button>
        <button type="button" class="back-button" onclick="showLoginChoice()">è¿”å›</button>
      </form>
    </div>
  </div>

  <!-- ç”¨æˆ·é¡µé¢æ¨¡æ€æ¡† -->
  <div class="user-modal-overlay" id="userModalOverlay" onclick="closeUserModal()"></div>
  <div class="user-modal" id="userModal">
    <span class="modal-close" onclick="closeUserModal()">&times;</span>
    <div id="userContent" class="user-content"></div>
  </div>
  <!-- å·¦å³åˆ‡æ¢æŒ‰é’®ï¼ˆç‹¬ç«‹äºæ¨¡æ€æ¡†ï¼Œé¿å…è¢«overflowè£å‰ªï¼‰ -->
  <div class="user-chevron prev" onclick="userChevronPrev()" aria-label="ä¸Šä¸€ä½">&lt;</div>
  <div class="user-chevron next" onclick="userChevronNext()" aria-label="ä¸‹ä¸€ä½">&gt;</div>

  <!-- ç”¨æˆ·åˆ—è¡¨ä¾§è¾¹æ  -->
  <div class="users-sidebar-overlay" id="usersSidebarOverlay" onclick="closeUsersSidebar()"></div>
  <div class="users-sidebar" id="usersSidebar">
    <div id="usersSidebarGrid" class="sidebar-users-grid"></div>
  </div>
  <!-- å³ä¾§æ ‡ç­¾æŒ‰é’®ï¼šç‚¹å‡»åˆ‡æ¢ä¾§è¾¹æ  -->
  <div class="users-sidebar-tab" id="usersSidebarTab" onclick="toggleUsersSidebarTab()" title="ç”¨æˆ·åˆ—è¡¨">&lt;</div>

  <!-- æˆ‘çš„ç•™è¨€é¡µé¢ -->
  <div class="my-messages-overlay" id="myMessagesOverlay" onclick="closeMyMessages()"></div>
  <div class="my-messages-page" id="myMessagesPage">
    <div class="messages-header">
      <h2>æˆ‘æ”¶åˆ°çš„ç•™è¨€</h2>
      <span class="modal-close" onclick="closeMyMessages()">&times;</span>
    </div>
    <div id="myMessagesList" class="messages-list"></div>
  </div>

  <!-- å…³ç³»ä¸­å¿ƒé¡µé¢ï¼ˆæŸ¥çœ‹å·²å»ºç«‹ä¸å¾…å¤„ç†ã€ä»¥åŠå¤„ç†æ“ä½œï¼‰ -->
  <div class="my-messages-overlay" id="relationshipCenterOverlay" onclick="closeRelationshipCenter()"></div>
  <div class="my-messages-page" id="relationshipCenterPage">
    <div class="messages-header">
      <h2>å…³ç³»ä¸­å¿ƒ</h2>
      <span class="modal-close" onclick="closeRelationshipCenter()">&times;</span>
    </div>
    <div id="relationshipCenterContent" class="messages-list"></div>
  </div>

  <!-- åŠ è½½æç¤º -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- å¾½ç« æç¤ºæ°”æ³¡ -->
  <div class="badge-toast hidden" id="badgeToast">
    <span class="badge-icon-toast" id="badgeToastIcon"></span>
    <span id="badgeToastText"></span>
  </div>

  <!-- ç®¡ç†å‘˜å¯†ç è¾“å…¥å¼¹çª— -->
  <div class="admin-prompt-overlay" id="adminPromptOverlay" onclick="closeAdminPrompt()"></div>
  <div class="admin-prompt" id="adminPrompt">
    <h3>è¾“å…¥ç®¡ç†å‘˜å¯†ç </h3>
    <input type="password" id="adminPasswordInput" placeholder="å¯†ç " />
    <div class="admin-prompt-buttons">
      <button onclick="confirmAdminPassword()">ç¡®å®š</button>
      <button onclick="closeAdminPrompt()">å–æ¶ˆ</button>
    </div>
  </div>

  <!-- å…³ç³»ç”³è¯·å¼¹çª—ï¼ˆé€‰æ‹©å…³ç³»ç±»å‹ + è¾“å…¥ç•™è¨€ï¼‰ -->
  <div class="relationship-prompt-overlay" id="relationshipPromptOverlay" onclick="closeRelationshipPrompt()"></div>
  <div class="relationship-prompt" id="relationshipPrompt">
    <h3>å»ºç«‹å…³ç³»</h3>
    <p style="font-size: 14px; color: #888; margin-bottom: 20px;">è¯·é€‰æ‹©ä¸€ä¸ªå…³ç³»ç±»å‹ï¼š</p>
    
    <!-- å…³ç³»ç±»å‹é€‰æ‹©æŒ‰é’®ï¼ˆå·²æ›¿æ¢ä¸ºå…­ç§æ–°å…³ç³»ï¼‰ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
      <button class="relationship-type-btn" onclick="selectRelationshipType('eternal')" data-type="eternal">
        <div style="font-size: 28px; margin-bottom: 6px;">ğŸª¢</div>
        <div style="font-size: 14px; font-weight: 600;">Eternal Bond</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('backforth')" data-type="backforth">
        <div style="font-size: 28px; margin-bottom: 6px;">ğŸ¸</div>
        <div style="font-size: 14px; font-weight: 600;">Back and Forth</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('investor')" data-type="investor">
        <div style="font-size: 28px; margin-bottom: 6px;">ğŸ’¸</div>
        <div style="font-size: 14px; font-weight: 600;">Angel Investor</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('teddy')" data-type="teddy">
        <div style="font-size: 28px; margin-bottom: 6px;">ğŸ§¸</div>
        <div style="font-size: 14px; font-weight: 600;">Needy Teddy</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('time')" data-type="time">
        <div style="font-size: 28px; margin-bottom: 6px;">â³</div>
        <div style="font-size: 14px; font-weight: 600;">Time Needed</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('blah')" data-type="blah">
        <div style="font-size: 28px; margin-bottom: 6px;">ğŸ’¬</div>
        <div style="font-size: 14px; font-weight: 600;">Blah Blah</div>
      </button>
    </div>

    <!-- ç•™è¨€è¾“å…¥æ¡† -->
    <p style="font-size: 14px; color: #888; margin-bottom: 8px;">ç”³è¯·ç•™è¨€ï¼ˆå¿…å¡«ï¼‰ï¼š</p>
    <textarea id="relationshipMessage" placeholder="è¯´è¯´ä½ ä¸ºä»€ä¹ˆæƒ³ä¸å¯¹æ–¹å»ºç«‹è¿™ç§å…³ç³»..." 
              style="width: 100%; height: 80px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f5f5f5; font-family: 'Lato', sans-serif; resize: vertical; margin-bottom: 16px;"></textarea>

    <!-- æ“ä½œæŒ‰é’® -->
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeRelationshipPrompt()" style="padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
      <button onclick="submitRelationshipRequest(window._selectedRelationType)" style="padding: 10px 20px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">å‘é€ç”³è¯·</button>
    </div>
  </div>

  <!-- è§£é™¤å…³ç³»å¼¹çª—ï¼ˆè¾“å…¥åŸå› ï¼‰ -->
  <div class="relationship-prompt-overlay" id="dissolvePromptOverlay" onclick="closeDissolvePrompt()"></div>
  <div class="relationship-prompt" id="dissolvePrompt">
    <h3>è§£é™¤å…³ç³»</h3>
    <p style="font-size: 14px; color: #888; margin-bottom: 20px;">è¯·è¯´æ˜è§£é™¤å…³ç³»çš„åŸå› ï¼š</p>
    <textarea id="dissolveReasonInput" placeholder="è¾“å…¥è§£é™¤åŸå› ï¼ˆå¯é€‰ï¼‰..." 
      style="width: 100%; min-height: 100px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f5f5f5; font-size: 14px; resize: vertical; font-family: 'Lato', sans-serif; margin-bottom: 20px;"></textarea>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeDissolvePrompt()" style="padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
      <button onclick="submitDissolveRequest()" style="padding: 10px 20px; background: rgba(255,68,68,0.2); border: 1px solid rgba(255,68,68,0.4); color: #ff4444; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">ç¡®è®¤è§£é™¤</button>
    </div>
  </div>

  <!-- åˆ é™¤è´¦æˆ·ç¡®è®¤å¼¹çª— -->
  <div class="admin-prompt-overlay" id="deleteAccountOverlay" onclick="closeDeleteAccountPrompt()"></div>
  <div class="admin-prompt" id="deleteAccountPrompt">
    <h3 style="color: #ff4444; font-size: 18px;">âš ï¸ æ³¨é”€è´¦æˆ·</h3>
    <p id="deleteAccountMessage" style="color: #ccc; margin: 20px 0; line-height: 1.6;"></p>
    <div style="display: flex; gap: 12px;">
      <button onclick="closeDeleteAccountPrompt()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">å–æ¶ˆ</button>
      <button onclick="confirmDeleteAccount()" style="flex: 1; padding: 12px; background: rgba(255,68,68,0.25); border: 1px solid rgba(255,68,68,0.5); color: #ff4444; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">ç¡®è®¤æ³¨é”€</button>
    </div>
  </div>

  <!-- åˆ é™¤æ‰€æœ‰å¼¹å¹•ç¡®è®¤å¼¹çª— -->
  <div class="admin-prompt-overlay" id="deleteAllDanmakuOverlay" onclick="closeDeleteAllDanmakuPrompt()"></div>
  <div class="admin-prompt" id="deleteAllDanmakuPrompt">
    <h3 style="color: #ff4444; font-size: 18px;">ğŸ—‘ï¸ åˆ é™¤æˆ‘çš„æ‰€æœ‰å¼¹å¹•</h3>
    <p style="color: #ccc; margin: 20px 0; line-height: 1.6;">
      ç¡®å®šè¦åˆ é™¤ä½ å‘é€çš„æ‰€æœ‰å¼¹å¹•ç•™è¨€å—ï¼Ÿ<br/>
      <strong style="color: #ff8888;">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</strong>
    </p>
    <p id="deleteAllDanmakuCount" style="color: var(--avatar-border-color); margin: 10px 0; font-size: 14px; text-align: center; transition: color 2s ease;"></p>
    <div style="display: flex; gap: 12px;">
      <button onclick="closeDeleteAllDanmakuPrompt()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">å–æ¶ˆ</button>
      <button onclick="confirmDeleteAllDanmaku()" style="flex: 1; padding: 12px; background: rgba(255,68,68,0.25); border: 1px solid rgba(255,68,68,0.5); color: #ff4444; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">ç¡®è®¤åˆ é™¤</button>
    </div>
  </div>

  <!-- å¼¹å¹•å¢™è¦†ç›–å±‚ -->
  <div class="danmaku-wall-overlay" id="danmakuWallOverlay">
    <!-- é¡¶éƒ¨æ§åˆ¶æ ï¼ˆå»é™¤æ ‡é¢˜å’Œåˆ†å‰²çº¿ï¼Œä»…iconæŒ‰é’®ï¼‰ -->
    <div class="danmaku-header" style="border-bottom:none;background:transparent;padding:20px 40px 0 40px;">
      <div class="danmaku-controls" style="gap:12px;">
        <button id="danmakuPauseBtn" onclick="toggleDanmakuPause()" title="Pause/Play" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--avatar-glow-color);border:1px solid var(--avatar-border-color);border-radius:50%;color:var(--avatar-border-color);cursor:pointer;transition:all 0.3s ease;">
          <svg id="danmakuPauseIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:20px;height:20px;">
            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
          </svg>
        </button>
        <button id="danmakuReplayBtn" onclick="replayDanmaku()" title="Replay" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--avatar-glow-color);border:1px solid var(--avatar-border-color);border-radius:50%;color:var(--avatar-border-color);cursor:pointer;transition:all 0.3s ease;">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:20px;height:20px;">
            <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6 0 1.3-.42 2.5-1.13 3.47l1.46 1.46C19.07 16.07 20 14.13 20 12c0-4.42-3.58-8-8-8zm-6.87.13L3.13 6.54C2.42 7.5 2 8.7 2 10c0 4.42 3.58 8 8 8v4l5-5-5-5v4c-3.31 0-6-2.69-6-6 0-1.3.42-2.5 1.13-3.47z"/>
          </svg>
        </button>
        <button id="danmakuDeleteAllBtn" onclick="showDeleteAllDanmakuPrompt()" title="Delete All My Messages" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:rgba(255,68,68,0.15);border:1px solid rgba(255,68,68,0.4);border-radius:50%;color:#ff4444;cursor:pointer;transition:all 0.3s ease;">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:20px;height:20px;">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
          </svg>
        </button>
        <button class="modal-close" onclick="closeDanmakuWall()" title="Close" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--avatar-glow-color);border:1px solid var(--avatar-border-color);border-radius:50%;color:var(--avatar-border-color);cursor:pointer;transition:all 0.3s ease;">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:20px;height:20px;">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- å¼¹å¹•å®¹å™¨ -->
    <div class="danmaku-container" id="danmakuContainer">
      <!-- å¼¹å¹•ä¼šåŠ¨æ€æ’å…¥è¿™é‡Œ -->
    </div>

    <!-- åº•éƒ¨è¾“å…¥åŒº -->
    <div class="danmaku-input-area">
      <div class="danmaku-user-avatar" id="danmakuUserAvatar">
        <!-- æ˜¾ç¤ºå½“å‰ç”¨æˆ·å¤´åƒ -->
      </div>
      <input
        type="text"
        id="danmakuInput"
        placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
        maxlength="50"
      />
      <button onclick="sendDanmaku()">å‘é€</button>
    </div>
  </div>

  <!-- Emojiæ¸¸æˆ - å‡ºé¢˜é¡µ -->
  <div class="emoji-create-overlay" id="emojiCreateOverlay" style="display:none;">
    <div class="emoji-create-page">
      <span class="modal-close" onclick="closeEmojiCreatePage()">&times;</span>
      <h2 style="font-family: 'Playfair Display', serif; font-size: 36px; margin-bottom: 30px; color: var(--avatar-border-color); transition: color 2s ease;">å‡ºé¢˜</h2>

      <div style="margin-bottom: 30px;">
        <label style="display: block; font-size: 14px; margin-bottom: 10px; color: #ccc;">ç”µå½±å <span style="color: #ff4444;">*</span></label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <div id="randomTitleDisplay" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--avatar-border-color); border-radius: 8px; padding: 12px 15px; color: var(--avatar-border-color); font-size: 16px; font-weight: 500; transition: all 2s ease;"></div>
          <button id="refreshTitleBtn" onclick="refreshRandomTitle()" style="padding: 12px 20px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease, background 2s ease, border-color 2s ease;">ğŸ”„ æ¢ä¸€ä¸ª</button>
        </div>
        <input type="text" id="customTitleInput" placeholder="æˆ–è€…è¾“å…¥è‡ªå®šä¹‰ç”µå½±å..." style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 12px 15px; color: #f5f5f5; font-size: 14px;" />
      </div>

      <div style="margin-bottom: 30px;">
        <label style="display: block; font-size: 14px; margin-bottom: 10px; color: #ccc;">ç”¨emojiè¡¨è¾¾è¿™éƒ¨ç”µå½± (1-6ä¸ª) <span style="color: #ff4444;">*</span></label>
        <input type="text" id="emojiInput" placeholder="è¾“å…¥1-6ä¸ªemoji..." style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 12px 15px; color: #f5f5f5; font-size: 24px;" />
        <div id="emojiValidationMsg" style="margin-top: 8px; font-size: 13px; color: #ff4444; min-height: 18px;"></div>
        <!-- Emoji åˆ†ç±»é¢æ¿ -->
        <div id="emojiPicker" class="emoji-picker">
          <div class="emoji-picker-tabs" id="emojiPickerTabs"></div>
          <div class="emoji-picker-controls">
            <input id="emojiPickerSearch" type="text" placeholder="æœç´¢è¡¨æƒ…..." aria-label="æœç´¢è¡¨æƒ…" />
            <div class="emoji-picker-pager">
              <button id="emojiPagerPrev" type="button">â€¹</button>
              <span id="emojiPagerInfo">1 / 1</span>
              <button id="emojiPagerNext" type="button">â€º</button>
            </div>
          </div>
          <div class="emoji-picker-grid" id="emojiPickerGrid"></div>
        </div>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button onclick="closeEmojiCreatePage()" style="padding: 12px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">å–æ¶ˆ</button>
        <button id="publishPuzzleBtn" onclick="publishPuzzleUI()" disabled style="padding: 12px 24px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease, background 2s ease, border-color 2s ease; opacity: 0.5;">å‘å¸ƒé¢˜ç›®</button>
      </div>
    </div>
  </div>

  <!-- Emojiæ¸¸æˆ - å¤§å…é¡µ -->
  <div class="emoji-hall-overlay" id="emojiHallOverlay" style="display:none;">
    <div class="emoji-hall-page">
      <div class="emoji-hall-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <h2 style="font-family: 'Playfair Display', serif; font-size: 36px; color: var(--avatar-border-color); transition: color 2s ease; margin: 0;">çŒœé¢˜å¤§å…</h2>
          <button class="emoji-hall-leaderboard-btn" onclick="showEmojiLeaderboard()" title="æ’è¡Œæ¦œ">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
              <path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/>
            </svg>
          </button>
        </div>
        <span class="modal-close" onclick="closeEmojiHallPage()">&times;</span>
      </div>
      <div id="emojiHallList" class="emoji-hall-list">
        <!-- é¢˜ç›®åˆ—è¡¨åŠ¨æ€æ’å…¥ -->
      </div>
    </div>
  </div>

  <!-- Emojiæ¸¸æˆ - çŒœé¢˜å¼¹çª— -->
  <div class="emoji-guess-overlay" id="emojiGuessOverlay" style="display:none;">
    <div class="emoji-guess-modal">
      <span class="modal-close" onclick="closeEmojiGuessModal()">&times;</span>
      <div id="emojiGuessContent">
        <!-- çŒœé¢˜å†…å®¹åŠ¨æ€æ’å…¥ -->
      </div>
    </div>
  </div>

  <!-- Emojiæ¸¸æˆ - æ’è¡Œæ¦œé¡µ -->
  <div class="emoji-leaderboard-overlay" id="emojiLeaderboardOverlay" style="display:none;">
    <div class="emoji-leaderboard-page">
      <div class="emoji-hall-header">
        <h2 style="font-family: 'Playfair Display', serif; font-size: 36px; color: var(--avatar-border-color); transition: color 2s ease;">æ’è¡Œæ¦œ</h2>
        <span class="modal-close" onclick="closeEmojiLeaderboard()">&times;</span>
      </div>
      <div id="emojiLeaderboardList" class="emoji-leaderboard-list">
        <!-- æ’è¡Œæ¦œåˆ—è¡¨åŠ¨æ€æ’å…¥ -->
      </div>
    </div>
  </div>

  <!-- é€šç”¨ç¡®è®¤å¯¹è¯æ¡† -->
  <div class="confirm-dialog-overlay" id="confirmDialogOverlay"></div>
  <div class="confirm-dialog" id="confirmDialog">
    <h3 id="confirmDialogTitle" style="font-size: 18px; color: #f5f5f5; margin-bottom: 20px;">ç¡®è®¤æ“ä½œ</h3>
    <p id="confirmDialogMessage" style="color: #ccc; margin-bottom: 24px; line-height: 1.6;"></p>
    <div style="display: flex; gap: 12px; justify-content: flex-end;">
      <button id="confirmDialogCancelBtn" style="padding: 10px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">å–æ¶ˆ</button>
      <button id="confirmDialogConfirmBtn" style="padding: 10px 24px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">ç¡®å®š</button>
    </div>
  </div>

  <!-- App Scripts: æ³¨æ„é¡ºåºï¼Œéæ¨¡å—ï¼Œå…¨å±€æš´éœ² -->
  <script src="./js/config.js"></script>
  <script src="./js/data.js"></script>
  <script src="./js/firebase.js"></script>
  <script src="./js/ui.js"></script>
  <script src="./js/quiz.js"></script>
  <script src="./js/user.js"></script>
  <script src="./js/admin.js"></script>
  <script src="./js/gestures.js"></script>
  <script src="./js/messages.js"></script>
  <script src="./js/timeTheme.js"></script>
  <script src="./js/danmaku.js"></script>
  <script src="./js/emojiQuiz.js"></script>
  <script src="./js/emojiQuizUI.js"></script>
  <script>
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function(){
      if (window.initAvatarSelector) window.initAvatarSelector();
      if (window.initGestures) window.initGestures();
      if (window.initUserCorner) window.initUserCorner();
      if (window.initUsersSidebarTab) window.initUsersSidebarTab();
      if (window.initTimeTheme) window.initTimeTheme();
      if (window.initEmojiQuizUI) window.initEmojiQuizUI();
    });
  </script>
</body>
</html>
