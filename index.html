<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Movie!</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="./css/styles.css" />
  <!-- 提前加载时间感知主题，减少首屏闪烁 -->
  <script src="./js/timeTheme.js" defer></script>

  <!-- Firebase SDK (Compat) placed before app scripts) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body>
  <!-- 左上角用户入口 -->
  <div class="user-corner" id="userCorner">
    <!-- 未登录时显示火焰 -->
    <div class="corner-flame" id="cornerFlame" onclick="showLoginModal()">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
        <path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/>
      </svg>
    </div>
    
    <!-- 登录后显示用户头像 -->
    <div class="corner-avatar" id="cornerAvatar" onclick="toggleUserMenu()" style="display:none;">
      <div class="corner-avatar-img" id="cornerAvatarImg"></div>
      <div class="corner-badge" id="cornerBadge" style="display:none;">0</div>
    </div>
  </div>

  <!-- 用户下拉菜单 -->
  <div class="user-dropdown" id="userDropdown">
    <div class="user-dropdown-header">
        <div class="dropdown-avatar" id="dropdownAvatar"></div>
        <div class="dropdown-info" style="display:flex; align-items:center; gap:8px; justify-content:space-between; width:100%;">
          <div class="dropdown-nickname" id="dropdownNickname"></div>
          <!-- 名字右侧展示关系徽标（>2 折叠为 X个关系） -->
          <div class="dropdown-relations" id="dropdownRelations"></div>
        </div>
    </div>
    <div class="user-dropdown-body">
      <div class="dropdown-info-item">
        <strong>最喜欢的导演：</strong><span id="dropdownDirector"></span>
      </div>
      <div class="dropdown-info-item">
        <strong>最喜欢的电影：</strong><span id="dropdownFilm"></span>
      </div>
      <div class="dropdown-badges" id="dropdownBadges"></div>
        <!-- 电影风格移动到徽章下方一行展示 -->
        <div class="dropdown-style-below" id="dropdownStyleBelow" style="margin-top:6px; color:#bbb; font-size:13px;"></div>
    </div>
    <div class="user-dropdown-actions">
        <button class="dropdown-btn" onclick="showUserPage(window.currentUser.id)">👤 查看我的主页</button>
        <button class="dropdown-btn" onclick="editOwnProfile()">✏️ 编辑资料</button>
        <button class="dropdown-btn" onclick="showMyMessages()">📬 查看我的留言 <span id="dropdownMsgPill" style="display:none; margin-left:6px; padding:2px 6px; background:var(--avatar-glow-color); border:1px solid var(--avatar-border-color); color:var(--avatar-border-color); border-radius:10px; font-size:12px;"></span></button>
        <button class="dropdown-btn" onclick="showRelationshipCenter()">🤝 关系处理 <span id="dropdownRelPill" style="display:none; margin-left:6px; padding:2px 6px; background:var(--avatar-glow-color); border:1px solid var(--avatar-border-color); color:var(--avatar-border-color); border-radius:10px; font-size:12px;"></span></button>
      <button class="dropdown-btn" onclick="showAdminPrompt()">👑 管理员模式</button>
      <button class="dropdown-btn" onclick="logoutUser()">🚪 退出登录</button>
      <button class="dropdown-btn danger" onclick="deleteOwnAccount()">⚠️ 注销账户</button>
    </div>
  </div>

  <!-- 电影胶片背景 -->
  <div class="film-strip-background" id="filmBackground"></div>

  <!-- 流动诗意排版的导演名字 -->
  <div class="directors-layer" id="directorsLayer"></div>

  <!-- 左下角功能菜单 -->
  <div class="function-menu-container" id="functionMenuContainer" style="display:none;">
    <!-- 主功能键（网格图标） -->
    <div class="main-function-button" id="mainFunctionButton" onclick="toggleFunctionMenu()" title="功能菜单">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
        <path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/>
      </svg>
      <div class="emoji-hall-badge" id="mainFunctionBadge" style="display:none;">0</div>
    </div>

    <!-- 子功能按钮容器 -->
    <div class="sub-function-buttons" id="subFunctionButtons">
      <!-- 测验按钮 -->
      <div class="sub-function-button" onclick="startQuiz()" title="开始测验">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
          <path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
        </svg>
      </div>

      <!-- 出题按钮 -->
      <div class="sub-function-button" onclick="showEmojiCreatePage()" title="出题">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
          <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
          <path d="M5.5 16c.83 0 1.5-.67 1.5-1.5S6.33 13 5.5 13 4 13.67 4 14.5 4.67 16 5.5 16z"/>
          <path d="M18.5 16c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5z"/>
        </svg>
      </div>

      <!-- 猜题大厅按钮 -->
      <div class="sub-function-button" onclick="showEmojiHallPage()" title="猜题大厅">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
          <path d="M9 21h6v-1.5H9V21zm3-19C7.92 2 5 4.92 5 8c0 2.38 1.19 4.47 3 5.74V16c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.08-2.92-6-6-6z"/>
        </svg>
        <div class="emoji-hall-badge" id="emojiHallBadge" style="display:none;">0</div>
      </div>

      <!-- 排行榜按钮 -->
      <div class="sub-function-button" onclick="showEmojiLeaderboard()" title="排行榜">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
          <path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/>
        </svg>
      </div>

      <!-- 留言墙按钮 -->
      <div class="sub-function-button" onclick="toggleDanmakuWall()" title="留言墙">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
          <path d="M17 10.5V7c0-1.1-.9-2-2-2H5C3.9 5 3 5.9 3 7v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-3.5l4 4v-11l-4 4z"/>
        </svg>
        <div class="emoji-hall-badge" id="danmakuBadge" style="display:none;">0</div>
      </div>
    </div>
  </div>

  <!-- 导演弹窗 -->
  <div class="modal" id="directorModal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- 测验覆盖层 -->
  <div class="quiz-overlay" id="quizOverlay">
    <!-- 测验页面 -->
    <div id="quizPage" class="quiz-container">
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="question-number" id="questionNumber">问题 1 / 5</div>
      <div class="question-text" id="questionText"></div>
      <div class="question-image hidden" id="questionImage"><img id="questionImg" alt="question" /></div>
      <div id="answerContainer">
        <input id="answerInput" class="answer-input" placeholder="请输入答案" />
        <div id="optionsContainer" class="options-container hidden"></div>
      </div>
      <button class="quiz-button" onclick="handleNext()">下一题</button>
      <button class="quiz-button" onclick="closeQuiz()">关闭</button>
    </div>
  </div>

  <!-- 登录/注册模态框 -->
  <div class="login-modal-overlay" id="loginModalOverlay" onclick="closeLoginModal()"></div>
  <div class="login-modal" id="loginModal">
    <span class="modal-close" onclick="closeLoginModal()">&times;</span>
    
    <!-- 登录/注册选择 -->
    <div id="loginChoice" class="login-choice">
      <h2>Welcome!</h2>
      <button class="choice-button" onclick="showRegisterForm()">🔥 第一次来？</button>
      <button class="choice-button" onclick="showLoginForm()">✨ 已经来过？</button>
    </div>

    <!-- 登录表单 -->
    <div id="loginForm" class="auth-form hidden">
      <h2>登录</h2>
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="loginNickname">昵称</label>
          <input id="loginNickname" type="text" required placeholder="输入你的昵称" />
        </div>
        <div class="form-group">
          <label for="loginPassword">密码</label>
          <input id="loginPassword" type="password" required placeholder="输入你的密码" />
        </div>
        <button type="submit" class="submit-button">登录</button>
        <button type="button" class="back-button" onclick="showLoginChoice()">返回</button>
      </form>
    </div>

    <!-- 注册表单 -->
    <div id="registerForm" class="auth-form hidden">
      <h2>注册</h2>
      <form onsubmit="handleRegister(event)" id="regForm">
        <!-- 头像选择器 -->
        <div class="form-group">
          <label>选择头像 *</label>
          <small>点击选择，未选择将自动生成首字母头像</small>
          <div class="avatar-selector" id="avatarSelector"></div>
          <input type="hidden" id="selectedAvatar" value="" />
        </div>

        <!-- 昵称 -->
        <div class="form-group">
          <label for="regNickname">昵称 *</label>
          <input id="regNickname" type="text" required placeholder="输入你的昵称" />
        </div>

        <!-- 密码 -->
        <div class="form-group">
          <label for="regPassword">密码 *</label>
          <input id="regPassword" type="password" required placeholder="至少4个字符" />
        </div>
        <div class="form-group">
          <label for="regPasswordConfirm">确认密码 *</label>
          <input id="regPasswordConfirm" type="password" required placeholder="再次输入密码" />
        </div>

        <!-- 最喜欢的女导演 -->
        <div class="form-group">
          <label for="favoriteDirector">最喜欢的女导演 *</label>
          <input id="favoriteDirector" type="text" required placeholder="如：阿涅斯·瓦尔达" />
        </div>

        <!-- 最喜欢的女性电影 -->
        <div class="form-group">
          <label for="favoriteFilm">最喜欢的女性电影 *</label>
          <input id="favoriteFilm" type="text" required placeholder="如：燃烧女子的肖像" />
        </div>

        <!-- 最近看的电影（可选） -->
        <div class="form-group">
          <label for="recentFilm">最近看的一部电影（可选）</label>
          <input id="recentFilm" type="text" placeholder="如：阿涅斯论瓦尔达" />
        </div>

        <!-- 分享想法（可选） -->
        <div class="form-group">
          <label for="thoughts">分享你最近好玩的想法（可选）</label>
          <textarea id="thoughts" rows="3" placeholder="写下你的想法..."></textarea>
        </div>

        <button type="submit" class="submit-button">注册</button>
        <button type="button" class="back-button" onclick="showLoginChoice()">返回</button>
      </form>
    </div>
  </div>

  <!-- 用户页面模态框 -->
  <div class="user-modal-overlay" id="userModalOverlay" onclick="closeUserModal()"></div>
  <div class="user-modal" id="userModal">
    <span class="modal-close" onclick="closeUserModal()">&times;</span>
    <div id="userContent" class="user-content"></div>
  </div>
  <!-- 左右切换按钮（独立于模态框，避免被overflow裁剪） -->
  <div class="user-chevron prev" onclick="userChevronPrev()" aria-label="上一位">&lt;</div>
  <div class="user-chevron next" onclick="userChevronNext()" aria-label="下一位">&gt;</div>

  <!-- 用户列表侧边栏 -->
  <div class="users-sidebar-overlay" id="usersSidebarOverlay" onclick="closeUsersSidebar()"></div>
  <div class="users-sidebar" id="usersSidebar">
    <div id="usersSidebarGrid" class="sidebar-users-grid"></div>
  </div>
  <!-- 右侧标签按钮：点击切换侧边栏 -->
  <div class="users-sidebar-tab" id="usersSidebarTab" onclick="toggleUsersSidebarTab()" title="用户列表">&lt;</div>

  <!-- 我的留言页面 -->
  <div class="my-messages-overlay" id="myMessagesOverlay" onclick="closeMyMessages()"></div>
  <div class="my-messages-page" id="myMessagesPage">
    <div class="messages-header">
      <h2>我收到的留言</h2>
      <span class="modal-close" onclick="closeMyMessages()">&times;</span>
    </div>
    <div id="myMessagesList" class="messages-list"></div>
  </div>

  <!-- 关系中心页面（查看已建立与待处理、以及处理操作） -->
  <div class="my-messages-overlay" id="relationshipCenterOverlay" onclick="closeRelationshipCenter()"></div>
  <div class="my-messages-page" id="relationshipCenterPage">
    <div class="messages-header">
      <h2>关系中心</h2>
      <span class="modal-close" onclick="closeRelationshipCenter()">&times;</span>
    </div>
    <div id="relationshipCenterContent" class="messages-list"></div>
  </div>

  <!-- 加载提示 -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">加载中...</div>
    </div>
  </div>

  <!-- 徽章提示气泡 -->
  <div class="badge-toast hidden" id="badgeToast">
    <span class="badge-icon-toast" id="badgeToastIcon"></span>
    <span id="badgeToastText"></span>
    <button id="badgeToastAction" class="badge-toast-action hidden" type="button"></button>
  </div>

  <!-- 管理员密码输入弹窗 -->
  <div class="admin-prompt-overlay" id="adminPromptOverlay" onclick="closeAdminPrompt()"></div>
  <div class="admin-prompt" id="adminPrompt">
    <h3>输入管理员密码</h3>
    <input type="password" id="adminPasswordInput" placeholder="密码" />
    <div class="admin-prompt-buttons">
      <button onclick="confirmAdminPassword()">确定</button>
      <button onclick="closeAdminPrompt()">取消</button>
    </div>
  </div>

  <!-- 关系申请弹窗（选择关系类型 + 输入留言） -->
  <div class="relationship-prompt-overlay" id="relationshipPromptOverlay" onclick="closeRelationshipPrompt()"></div>
  <div class="relationship-prompt" id="relationshipPrompt">
    <h3>建立关系</h3>
    <p style="font-size: 14px; color: #888; margin-bottom: 20px;">请选择一个关系类型：</p>
    
    <!-- 关系类型选择按钮（已替换为六种新关系） -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
      <button class="relationship-type-btn" onclick="selectRelationshipType('eternal')" data-type="eternal">
        <div style="font-size: 28px; margin-bottom: 6px;">🪢</div>
        <div style="font-size: 14px; font-weight: 600;">Eternal Bond</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('backforth')" data-type="backforth">
        <div style="font-size: 28px; margin-bottom: 6px;">🏸</div>
        <div style="font-size: 14px; font-weight: 600;">Back and Forth</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('investor')" data-type="investor">
        <div style="font-size: 28px; margin-bottom: 6px;">💸</div>
        <div style="font-size: 14px; font-weight: 600;">Angel Investor</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('teddy')" data-type="teddy">
        <div style="font-size: 28px; margin-bottom: 6px;">🧸</div>
        <div style="font-size: 14px; font-weight: 600;">Needy Teddy</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('time')" data-type="time">
        <div style="font-size: 28px; margin-bottom: 6px;">⏳</div>
        <div style="font-size: 14px; font-weight: 600;">Time Needed</div>
      </button>
      <button class="relationship-type-btn" onclick="selectRelationshipType('blah')" data-type="blah">
        <div style="font-size: 28px; margin-bottom: 6px;">💬</div>
        <div style="font-size: 14px; font-weight: 600;">Blah Blah</div>
      </button>
    </div>

    <!-- 留言输入框 -->
    <p style="font-size: 14px; color: #888; margin-bottom: 8px;">申请留言（必填）：</p>
    <textarea id="relationshipMessage" placeholder="说说你为什么想与对方建立这种关系..." 
              style="width: 100%; height: 80px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f5f5f5; font-family: 'Lato', sans-serif; resize: vertical; margin-bottom: 16px;"></textarea>

    <!-- 操作按钮 -->
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeRelationshipPrompt()" style="padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px;">取消</button>
      <button onclick="submitRelationshipRequest(window._selectedRelationType)" style="padding: 10px 20px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">发送申请</button>
    </div>
  </div>

  <!-- 解除关系弹窗（输入原因） -->
  <div class="relationship-prompt-overlay" id="dissolvePromptOverlay" onclick="closeDissolvePrompt()"></div>
  <div class="relationship-prompt" id="dissolvePrompt">
    <h3>解除关系</h3>
    <p style="font-size: 14px; color: #888; margin-bottom: 20px;">请说明解除关系的原因：</p>
    <textarea id="dissolveReasonInput" placeholder="输入解除原因（可选）..." 
      style="width: 100%; min-height: 100px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #f5f5f5; font-size: 14px; resize: vertical; font-family: 'Lato', sans-serif; margin-bottom: 20px;"></textarea>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeDissolvePrompt()" style="padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px;">取消</button>
      <button onclick="submitDissolveRequest()" style="padding: 10px 20px; background: rgba(255,68,68,0.2); border: 1px solid rgba(255,68,68,0.4); color: #ff4444; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">确认解除</button>
    </div>
  </div>

  <!-- 删除账户确认弹窗 -->
  <div class="admin-prompt-overlay" id="deleteAccountOverlay" onclick="closeDeleteAccountPrompt()"></div>
  <div class="admin-prompt" id="deleteAccountPrompt">
    <h3 style="color: #ff4444; font-size: 18px;">⚠️ 注销账户</h3>
    <p id="deleteAccountMessage" style="color: #ccc; margin: 20px 0; line-height: 1.6;"></p>
    <div style="display: flex; gap: 12px;">
      <button onclick="closeDeleteAccountPrompt()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">取消</button>
      <button onclick="confirmDeleteAccount()" style="flex: 1; padding: 12px; background: rgba(255,68,68,0.25); border: 1px solid rgba(255,68,68,0.5); color: #ff4444; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">确认注销</button>
    </div>
  </div>

  <!-- 删除所有弹幕确认弹窗 -->
  <div class="admin-prompt-overlay" id="deleteAllDanmakuOverlay" onclick="closeDeleteAllDanmakuPrompt()"></div>
  <div class="admin-prompt" id="deleteAllDanmakuPrompt">
    <h3 style="color: #ff4444; font-size: 18px;">🗑️ 删除我的所有弹幕</h3>
    <p style="color: #ccc; margin: 20px 0; line-height: 1.6;">
      确定要删除你发送的所有弹幕留言吗？<br/>
      <strong style="color: #ff8888;">此操作不可撤销！</strong>
    </p>
    <p id="deleteAllDanmakuCount" style="color: var(--avatar-border-color); margin: 10px 0; font-size: 14px; text-align: center; transition: color 2s ease;"></p>
    <div style="display: flex; gap: 12px;">
      <button onclick="closeDeleteAllDanmakuPrompt()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">取消</button>
      <button onclick="confirmDeleteAllDanmaku()" style="flex: 1; padding: 12px; background: rgba(255,68,68,0.25); border: 1px solid rgba(255,68,68,0.5); color: #ff4444; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">确认删除</button>
    </div>
  </div>

  <!-- 弹幕墙覆盖层 -->
  <div class="danmaku-wall-overlay" id="danmakuWallOverlay">
    <!-- 顶部控制栏（去除标题和分割线，仅icon按钮） -->
    <div class="danmaku-header" style="border-bottom:none;background:transparent;padding:20px 40px 0 40px;">
      <div class="danmaku-controls" style="gap:12px;">
        <button id="danmakuPauseBtn" onclick="toggleDanmakuPause()" title="Pause/Play" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--avatar-glow-color);border:1px solid var(--avatar-border-color);border-radius:50%;color:var(--avatar-border-color);cursor:pointer;transition:all 0.3s ease;">
          <svg id="danmakuPauseIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:20px;height:20px;">
            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
          </svg>
        </button>
        <button id="danmakuReplayBtn" onclick="replayDanmaku()" title="Replay" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--avatar-glow-color);border:1px solid var(--avatar-border-color);border-radius:50%;color:var(--avatar-border-color);cursor:pointer;transition:all 0.3s ease;">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:20px;height:20px;">
            <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6 0 1.3-.42 2.5-1.13 3.47l1.46 1.46C19.07 16.07 20 14.13 20 12c0-4.42-3.58-8-8-8zm-6.87.13L3.13 6.54C2.42 7.5 2 8.7 2 10c0 4.42 3.58 8 8 8v4l5-5-5-5v4c-3.31 0-6-2.69-6-6 0-1.3.42-2.5 1.13-3.47z"/>
          </svg>
        </button>
        <button id="danmakuDeleteAllBtn" onclick="showDeleteAllDanmakuPrompt()" title="Delete All My Messages" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:rgba(255,68,68,0.15);border:1px solid rgba(255,68,68,0.4);border-radius:50%;color:#ff4444;cursor:pointer;transition:all 0.3s ease;">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:20px;height:20px;">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
          </svg>
        </button>
        <button class="modal-close" onclick="closeDanmakuWall()" title="Close" style="width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--avatar-glow-color);border:1px solid var(--avatar-border-color);border-radius:50%;color:var(--avatar-border-color);cursor:pointer;transition:all 0.3s ease;">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:20px;height:20px;">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- 弹幕容器 -->
    <div class="danmaku-container" id="danmakuContainer">
      <!-- 弹幕会动态插入这里 -->
    </div>

    <!-- 底部输入区 -->
    <div class="danmaku-input-area">
      <div class="danmaku-user-avatar" id="danmakuUserAvatar">
        <!-- 显示当前用户头像 -->
      </div>
      <input
        type="text"
        id="danmakuInput"
        placeholder="说点什么..."
        maxlength="50"
      />
      <button onclick="sendDanmaku()">发送</button>
    </div>
  </div>

  <!-- Emoji游戏 - 出题页 -->
  <div class="emoji-create-overlay" id="emojiCreateOverlay" style="display:none;">
    <div class="emoji-create-page">
      <span class="modal-close" onclick="closeEmojiCreatePage()">&times;</span>
      <h2 style="font-family: 'Playfair Display', serif; font-size: 36px; margin-bottom: 20px; color: var(--avatar-border-color); transition: color 2s ease;">出题</h2>

      <!-- 公共：选择电影名 -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-size: 14px; margin-bottom: 10px; color: #ccc;">电影名 <span style="color: #ff4444;">*</span></label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <div id="randomTitleDisplay" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--avatar-border-color); border-radius: 8px; padding: 12px 15px; color: var(--avatar-border-color); font-size: 16px; font-weight: 500; transition: all 2s ease;"></div>
          <button id="refreshTitleBtn" onclick="refreshRandomTitle()" style="padding: 12px 20px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease, background 2s ease, border-color 2s ease;">🔄 换一个</button>
        </div>
        <input type="text" id="customTitleInput" placeholder="或者输入自定义电影名..." style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 12px 15px; color: #f5f5f5; font-size: 14px;" />
      </div>

      <div class="quiz-type-tabs" style="margin-bottom: 18px; display:flex; gap:10px;">
        <button id="createTabEmoji" class="quiz-type-tab-btn active" onclick="switchCreateQuizType('emoji')">Emoji</button>
        <button id="createTabStill" class="quiz-type-tab-btn" onclick="switchCreateQuizType('still')">剧照</button>
      </div>

      <div id="emojiCreateSection">
        <div style="margin-bottom: 30px;">
          <label style="display: block; font-size: 14px; margin-bottom: 10px; color: #ccc;">用emoji表达这部电影 (1-6个) <span style="color: #ff4444;">*</span></label>
          <input type="text" id="emojiInput" placeholder="输入1-6个emoji..." style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 12px 15px; color: #f5f5f5; font-size: 24px;" />
          <div id="emojiValidationMsg" style="margin-top: 8px; font-size: 13px; color: #ff4444; min-height: 18px;"></div>
          <!-- Emoji 分类面板 -->
          <div id="emojiPicker" class="emoji-picker">
            <div class="emoji-picker-tabs" id="emojiPickerTabs"></div>
            <div class="emoji-picker-controls">
              <input id="emojiPickerSearch" type="text" placeholder="搜索表情..." aria-label="搜索表情" />
              <div class="emoji-picker-pager">
                <button id="emojiPagerPrev" type="button">‹</button>
                <span id="emojiPagerInfo">1 / 1</span>
                <button id="emojiPagerNext" type="button">›</button>
              </div>
            </div>
            <div class="emoji-picker-grid" id="emojiPickerGrid"></div>
          </div>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button onclick="closeEmojiCreatePage()" style="padding: 12px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">取消</button>
          <button id="publishPuzzleBtn" onclick="publishPuzzleUI()" disabled style="padding: 12px 24px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease, background 2s ease, border-color 2s ease; opacity: 0.5;">发布题目</button>
        </div>
      </div>

      <div id="stillCreateSection" style="display:none;">
        <div style="margin-bottom: 24px;">
          <label style="display:block; font-size:14px; margin-bottom:10px; color:#ccc;">剧照图片 <span style="color:#ff4444;">*</span></label>
          <input type="file" id="stillImageInput" accept="image/*" style="margin-bottom:10px;" />
          <small style="display:block; color:#888; margin-top:4px;">上传后将自动压缩：最长边 1280px（可能降到 1024），目标 200–600KB，硬上限 800KB；会额外生成 480px 缩略图</small>
        </div>

        <div id="stillPreviewContainer" class="still-preview" style="margin-bottom:20px;">
          <img id="stillPreviewImage" alt="still preview" />
          <div id="stillGridOverlay" class="still-grid"></div>
          <div class="still-preview-hint">点击格子添加遮挡，至少保留 3 个亮格</div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display:block; font-size:14px; margin-bottom:10px; color:#ccc;">提示（可选）</label>
          <input type="text" id="stillHintInput" placeholder="写一个提示，留空则无提示" style="width:100%; background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:12px 15px; color:#f5f5f5; font-size:14px;" />
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top:20px;">
          <button onclick="closeEmojiCreatePage()" style="padding: 12px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">取消</button>
          <button id="publishStillBtn" onclick="publishStillPuzzleUI()" disabled style="padding: 12px 24px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease, background 2s ease, border-color 2s ease; opacity:0.5;">发布剧照题</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Emoji游戏 - 大厅页 -->
  <div class="emoji-hall-overlay" id="emojiHallOverlay" style="display:none;">
    <div class="emoji-hall-page">
      <div class="emoji-hall-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <h2 style="font-family: 'Playfair Display', serif; font-size: 36px; color: var(--avatar-border-color); transition: color 2s ease; margin: 0;">猜题大厅</h2>
          <button class="emoji-hall-leaderboard-btn" onclick="showEmojiLeaderboard()" title="排行榜">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
              <path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/>
            </svg>
          </button>
        </div>
        <span class="modal-close" onclick="closeEmojiHallPage()">&times;</span>
      </div>
      <div class="quiz-type-tabs" style="margin-bottom:14px; display:flex; gap:10px; justify-content:center;">
        <button id="hallTabEmoji" class="quiz-type-tab-btn active" onclick="switchHallQuizType('emoji')">
          Emoji
          <span id="hallTabEmojiBadge" class="quiz-type-tab-badge" style="display:none;">0</span>
        </button>
        <button id="hallTabStill" class="quiz-type-tab-btn" onclick="switchHallQuizType('still')">
          剧照
          <span id="hallTabStillBadge" class="quiz-type-tab-badge" style="display:none;">0</span>
        </button>
      </div>

      <div id="emojiHallSection">
        <div class="emoji-hall-tabs">
          <button id="hallTabOpenBtn" class="emoji-hall-tab-btn active" onclick="switchHallTab('open')">未猜出</button>
          <button id="hallTabSolvedBtn" class="emoji-hall-tab-btn" onclick="switchHallTab('solved')">已猜出</button>
        </div>
        <div id="emojiHallList" class="emoji-hall-list">
          <!-- 题目列表动态插入 -->
        </div>
      </div>

      <div id="stillHallSection" style="display:none;">
        <div class="emoji-hall-tabs">
          <button id="stillHallTabOpenBtn" class="emoji-hall-tab-btn active" onclick="switchStillHallTab('open')">未猜出</button>
          <button id="stillHallTabSolvedBtn" class="emoji-hall-tab-btn" onclick="switchStillHallTab('solved')">已猜出</button>
        </div>
        <div id="stillHallList" class="emoji-hall-list">
          <!-- 剧照题目列表 -->
        </div>
      </div>
    </div>
  </div>

  <!-- Emoji游戏 - 猜题弹窗 -->
  <div class="emoji-guess-overlay" id="emojiGuessOverlay" style="display:none;">
    <div class="emoji-guess-modal">
      <span class="modal-close" onclick="closeEmojiGuessModal()">&times;</span>
      <div id="emojiGuessContent">
        <!-- 猜题内容动态插入 -->
      </div>
    </div>
  </div>

  <!-- 剧照玩法 - 猜题弹窗 -->
  <div class="emoji-guess-overlay" id="stillGuessOverlay" style="display:none;">
    <div class="emoji-guess-modal">
      <span class="modal-close" onclick="closeStillGuessModal()">&times;</span>
      <div id="stillGuessContent">
        <!-- 剧照猜题内容 -->
      </div>
    </div>
  </div>

  <!-- Emoji游戏 - 排行榜页 -->
  <div class="emoji-leaderboard-overlay" id="emojiLeaderboardOverlay" style="display:none;">
    <div class="emoji-leaderboard-page">
      <div class="emoji-hall-header">
        <h2 style="font-family: 'Playfair Display', serif; font-size: 36px; color: var(--avatar-border-color); transition: color 2s ease;">排行榜</h2>
        <span class="modal-close" onclick="closeEmojiLeaderboard()">&times;</span>
      </div>

      <div class="quiz-type-tabs" style="display:flex; gap:10px; margin-bottom:16px; justify-content:center;">
        <button id="leaderboardTabEmoji" class="quiz-type-tab-btn active" onclick="switchLeaderboardQuizType('emoji')">Emoji</button>
        <button id="leaderboardTabStill" class="quiz-type-tab-btn" onclick="switchLeaderboardQuizType('still')">剧照</button>
      </div>

      <!-- Tab 切换按钮 -->
      <div id="emojiLeaderboardSection">
        <div class="leaderboard-tabs" style="display: flex; gap: 12px; margin-bottom: 24px; justify-content: center;">
          <button id="guessTabBtn" class="leaderboard-tab-btn active" onclick="switchLeaderboardTab('guess')" style="padding: 10px 24px; background: var(--avatar-glow-color); border: 2px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease;">
            猜对榜
          </button>
          <button id="influenceTabBtn" class="leaderboard-tab-btn" onclick="switchLeaderboardTab('influence')" style="padding: 10px 24px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease;">
            影响力榜
          </button>
        </div>

        <div id="emojiLeaderboardList" class="emoji-leaderboard-list">
          <!-- 排行榜列表动态插入 -->
        </div>
      </div>

      <div id="stillLeaderboardSection" style="display:none;">
        <div class="leaderboard-tabs" style="display: flex; gap: 12px; margin-bottom: 24px; justify-content: center;">
          <button id="stillGuessTabBtn" class="leaderboard-tab-btn active" onclick="switchStillLeaderboardTab('guess')" style="padding: 10px 24px; background: var(--avatar-glow-color); border: 2px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease;">
            猜对榜
          </button>
          <button id="stillInfluenceTabBtn" class="leaderboard-tab-btn" onclick="switchStillLeaderboardTab('influence')" style="padding: 10px 24px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease;">
            影响力榜
          </button>
        </div>
        <div id="stillLeaderboardList" class="emoji-leaderboard-list">
          <!-- 剧照排行榜 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 通用确认对话框 -->
  <div class="confirm-dialog-overlay" id="confirmDialogOverlay"></div>
  <div class="confirm-dialog" id="confirmDialog">
    <h3 id="confirmDialogTitle" style="font-size: 18px; color: #f5f5f5; margin-bottom: 20px;">确认操作</h3>
    <p id="confirmDialogMessage" style="color: #ccc; margin-bottom: 24px; line-height: 1.6;"></p>
    <div style="display: flex; gap: 12px; justify-content: flex-end;">
      <button id="confirmDialogCancelBtn" style="padding: 10px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">取消</button>
      <button id="confirmDialogConfirmBtn" style="padding: 10px 24px; background: var(--avatar-glow-color); border: 1px solid var(--avatar-border-color); color: var(--avatar-border-color); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">确定</button>
    </div>
  </div>

  <!-- App Scripts: 注意顺序，非模块，全局暴露 -->
  <script src="./js/config.js"></script>
  <script src="./js/data.js"></script>
  <script src="./js/firebase.js"></script>
  <script src="./js/ui.js"></script>
  <script src="./js/quiz.js"></script>
  <script src="./js/user.js"></script>
  <script src="./js/admin.js"></script>
  <script src="./js/gestures.js"></script>
  <script src="./js/messages.js"></script>
  <script src="./js/danmaku.js"></script>
  <script src="./js/emojiQuiz.js?v=5"></script>
  <script src="./js/emojiQuizUI.js?v=5"></script>
  <script src="./js/stillQuiz.js?v=5"></script>
  <script src="./js/stillQuizUI.js?v=5"></script>
  <script>
    // 初始化
    document.addEventListener('DOMContentLoaded', function(){
      if (window.initAvatarSelector) window.initAvatarSelector();
      if (window.initGestures) window.initGestures();
      if (window.initUserCorner) window.initUserCorner();
      if (window.initUsersSidebarTab) window.initUsersSidebarTab();
      if (window.initTimeTheme) window.initTimeTheme();
      if (window.initEmojiQuizUI) window.initEmojiQuizUI();
      if (window.initStillQuizUI) window.initStillQuizUI();
    });
  </script>
</body>
</html>
